<!--
gh-md-toc install.md
pandoc --standalone administration.md > install.html -->

# Installation of the `semantic_forms` generic application

Links

[Administration](administration.md)

Table of Contents
=================

   * [Installation of the semantic_forms generic application](#installation-of-the-semantic_forms-generic-application)
      * [Prerequisites](#prerequisites)
      * [Obtaining the zipped distribution](#obtaining-the-zipped-distribution)
      * [Runnning the zipped distribution](#runnning-the-zipped-distribution)
         * [On windows](#on-windows)
         * [URL of the main application page](#url-of-the-main-application-page)
            * [Stopping the zipped distribution](#stopping-the-zipped-distribution)
      * [Database manipulations](#database-manipulations)
      * [Settings when runnning the zipped distribution](#settings-when-runnning-the-zipped-distribution)
   * [Work with the semantic_forms distribution](#work-with-the-semantic_forms-distribution)
      * [Scripts for Unix](#scripts-for-unix)
      * [Managing server update](#managing-server-update)
      * [Managing multi administrators site](#managing-multi-administrators-site)
      * [Setup a new instance with common vocab's, form specifications, translations, dbPedia mirroring and Lucene indexing](#setup-a-new-instance-with-common-vocabs-form-specifications-translations-dbpedia-mirroring-and-lucene-indexing)
      * [Backup and recovery from backups](#backup-and-recovery-from-backups)


## Prerequisites 
- Java JRE 8 (check with `java -version`)

## Obtaining the zipped distribution
The zipped distribution is available as a [github release](https://github.com/jmvanel/semantic_forms/releases).

## Runnning the zipped distribution
Download this zip on the server, unzip and type (on Linux or Mac):
```shell
VERSION=2.4
cd semantic_forms_play-$VERSION
nohup bin/semantic_forms_play -J-Xmx50M &
```

`nohup` starts the web application so that it continues running after the user disconnects.
One can also simply run:
```
bin/semantic_forms_play -J-Xmx50M &
```
but then the application will be stopped when the user disconnects.

## Runnning on ports 80 and 443

After hesitating around several solutions, SF runs on port 80, simply by prefixing the usual shell script with
```shell
authbind --deep
```
Runnning on ports 80 and 443 (HTTPS)
the complete produre:

```shell
# the first time:
man authbind
sudo touch /etc/authbind/byport/80
sudo chmod 500 /etc/authbind/byport/80
sudo chown jmv /etc/authbind/byport/80
ls -l /etc/authbind/byport/80
# actually start:
nohup authbind --deep bin/semantic_forms_play -J-Xmx300M -J-server -Dhttp.port=80 &
# WIP: FAILS: Bind failed because of java.net.SocketException: Opération non permise
nohup authbind --deep bin/semantic_forms_play -J-Xmx300M -J-server -Dhttps.port=443 &
```

Of course, do not forget to stop any program running on port 80, e.g.
```shell
/etc/init.d/apache2 stop 
```

### On windows
**On windows** simply run:
```
bin\semantic_forms_play.bat -J-Xmx50M &
```
But there is a reported problem on Windows, related to the size of the classpath variable generated by the `semantic_forms_play.bat` script.
The message is:

```
The input line is too long.
The syntax of the command is incorrect.
```
This is probably corrected in Play! Framework 2.5 .
There is a workaround. Change the long line in `bin\semantic_forms_play.bat` with this one:
```
set "APP_CLASSPATH=%APP_LIB_DIR%..\conf\;%APP_LIB_DIR%*;"
```
See also:
http://stackoverflow.com/questions/21429234/play-framework-2-stage-task-on-windows-the-input-line-is-too-long

### URL of the main application page
The default port is 9000, so you can direct your browser to [http://localhost:9000](http://localhost:9000) .
The generic application is perfectly usable out of the box, see [User manual](https://github.com/jmvanel/semantic_forms/wiki/User_manual).
However, it is better to preload common RDF vocabularies and related form specifications and I18N translations, see below "Database manipulations".

#### Stopping the zipped distribution
`kill` the java application; its process ID is in the `RUNNING_PID` file.

## Database manipulations
It is better to preload common RDF vocabularies and related form specifications and I18N translations, for this run:
```shell
scripts/populateRDFCache.sh
```
**CAUTION: all scripts involving the database must be run when the web application is stopped.**

For more details, see: [preloading RDF content](../../scala/forms_play/README.md#preloading-rdf-content) .

To get all RDF data created by user "u:uu", run this:
```shell
scripts/graphdump.sh u:uu
```

## Settings when runnning the zipped distribution
You can change the default port (9000) to e.g. 9999 like this:

	nohup bin/semantic_forms_play -J-Xmx50M -Dhttp.port=9999 &

There is no need to be administrator.

You can set detailed loggin running like this:
```shell
PORT=9000
bin/semantic_forms_play -J-Xmx2000M -J-server -Dhttp.port=$PORT -Dlog4j.configurationFile=conf/log4j2.debug.properties
```
For more details on Run configuration:
[Play! framework documentation "Production Configuration"](https://www.playframework.com/documentation/2.5.x/ProductionConfiguration)

# Work with the `semantic_forms` distribution

## Scripts for Unix
Scripts are in the scripts/ directory. There are currently:

```
scripts/clone_implementation.sh
scripts/download-dbpedia.sh
scripts/dump.sh
scripts/graphdump.sh
scripts/graphload.sh
scripts/index_lucene.sh
scripts/load_dump_no_erase.sh
scripts/load_dump.sh
scripts/populateRDFCache.sh
scripts/populate_with_dbpedia.sh
scripts/start.sh
scripts/stop.sh
scripts/tdbsearch.sh
```

Of course, all the Jena command line tools are available, see:
https://jena.apache.org/documentation/tools/index.html
and for TDB, https://jena.apache.org/documentation/tdb/commands.html

## Managing server update

If you want to frequently update a server with respect to source code from git, there is the script:
`$HOME/src/semantic_forms/scala/scripts/update_server.sh`

Several variables can be customized at script beginning (see next paragraph).

## Managing multi administrators site

Currently, all compiled stuff (target/ directories made by SBT) for `semantic_forms` amounts to 500 Mbytes. The unzipped `semantic_forms` distribution amounts to 120 Mbytes.
There also 800 Mbytes in $HOME/.ivy2/ , the local Ivy depot used by SBT. 
So it makes sense to share all this among several administrators, each managing a different server on a different port.

So, for multiple administrators sharing usage: do this just once
- change DEPLOY variable in update_server.sh
- create a Linux group sf for sharing, and 3 shared directories:
```shell
sudo addgroup sf
function make_shared_dir {
  if [ $(getent group sf) ]; then
    DIR=$1
    sudo mkdir -p $DIR
    sudo chgrp -hR sf $DIR
    sudo chmod -R g+rwx $DIR
  fi
}
groups
DEPLOY=/var/www/sf_deploy
make_shared_dir $DEPLOY
SFSRC=/var/www/sf_src
make_shared_dir $SFSRC
IVY2=/var/www/ivy2
make_shared_dir $IVY2

# for each administrator user add it to the group
sudo usermod -a -G sf adminuser1
```
- populate 3 shared directories the first time, as a user belonging to group sf:
```shell
echo 'DEPLOY=/var/www/sf_deploy' >> ~/.bashrc
echo 'SFSRC=/var/www/sf_src' >> ~/.bashrc
echo 'IVY2=/var/www/ivy2' >> ~/.bashrc
DEPLOY=/var/www/sf_deploy
SFSRC=/var/www/sf_src
IVY2=/var/www/ivy2

ln -s $IVY2 $HOME/.ivy2

cd $SFSRC
git clone https://github.com/jmvanel/semantic_forms.git
make_shared_dir semantic_forms
make_shared_dir semantic_forms/.git

cd semantic_forms/scala
# change DEPLOY variable in update_server.sh to /var/www/sf_deploy
# install or make available SBT, see http://www.scala-sbt.org/
vi scripts/update_server.sh
./scripts/update_server.sh
# clone SF unzipped directory
cd $DEPLOY
cd semantic_forms_play-2.2-SNAPSHOT
./scripts/clone_implementation.sh
cd ..
mv semantic_forms_cloned ${USER}_instance
# of course , you can have several instances, just rename the cloned directory as you want.
cd ${USER}_instance
cp scripts/start.sh .
echo customize start.sh ( PORT ,etc )
vi start.sh
echo customize instance specific message
vi messages.html
```

The stage is set for your instance!
Now to start the instance on the chosen port:
```shell
cd $DEPLOY/${USER}_instance
./start.sh
```
To stop the instance on the chosen port:
```shell
cd $DEPLOY/${USER}_instance
./scripts/stop.sh
```

## Setup a new instance with common vocab's, form specifications, translations, dbPedia mirroring and Lucene indexing
The scripts must be run in this order:
```
scripts/populate_with_dbpedia.sh
scripts/populateRDFCache.sh
scripts/index_lucene.sh
```

## Backup and recovery from backups

The scripts to launch are: `dump.sh, clone_implementation.sh, load_dump.sh, start.sh`.
For example, starting from an installed directory `semantic_forms_play-1.0-SNAPSHOT`, this script backs up the data, then clones the distribution, then loads the backup into the freshly cloned distribution:

```
scripts/dump.sh
scripts/clone_implementation.sh
cd ../semantic_forms_cloned
scripts/load_dump.sh ../semantic_forms_play-1.0-SNAPSHOT
scripts/start.sh
```
NOTE:
There is currently no way to back up specifically the user data, it is mixed with the cached data.
However, it is possible to to back up the data of a specific user; as it is in a named graph derived from its user URI .


